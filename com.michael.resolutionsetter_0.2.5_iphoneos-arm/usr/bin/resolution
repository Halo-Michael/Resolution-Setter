#!/bin/bash

if [[ ! `id -u` == '0' ]];then
	echo 'Run this as root!'
	exit 1
fi

echo 'Welcome to use Apple Resolution Setter'

passconfirm=0

resolutionsetter() {
	read -p 'Please choice a height to set:' height
	read -p 'Please choice a width to set:' width
	if [[ ! $passconfirm == '1' ]];then
		read -p "Are you sure you want to set the resolution to ${height}x${width}?(y/n)" choice
	fi
}

fault_to_exit (){
	echo 'Invalid parameters, you may have no idea what you are doing, now exit.'
	sleep 2
	exit 1
}

if [[ $# > '4' ]];then
	fault_to_exit
fi

if [[ $# == '1' ]];then
	if [[ $1 == '-h' || $1 == '--help' ]];then
		echo 'Usage: res|resolution [height] [width] [-w] [-y]'
		echo
		echo '-w   Set resolution without auto respring. You may need to manual respring.'
		echo '-y   Pass the confirm message.'
		exit 0
	else
		fault_to_exit
	fi
fi

if [[ $# -ge '2' && $# -le '4' ]];then
	if [[ $# == '3' && ! $3 == '-w' && ! $3 == '-y' ]];then
		fault_to_exit
	else
		if [[ $# == '3' && $3 == '-y' ]];then
			passconfirm=1
		fi
	fi
	if [[ $# == '4' && ! $4 == '-y' ]];then
		fault_to_exit
	else
		if [[ $# == '4' ]];then
			passconfirm=1
		fi
	fi
	tmpheight=$1
	tmpwidth=$2
	expr $tmpheight + 0 &>/dev/null
	return1=$?
	expr $tmpwidth + 0 &>/dev/null
	return2=$?
	if [[ $return1 == '0' && $return2 == '0' ]];then
		resolutionsetter() {
			height=$tmpheight
			width=$tmpwidth
			if [[ ! $passconfirm == '1' ]];then
				read -p "Are you sure you want to set the resolution to ${height}x${width}?(y/n)" choice
			fi
		}
	else
		fault_to_exit
	fi
fi

while :
do
resolutionsetter
if [[ $choice == 'y' || $choice == 'Y' || $passconfirm == '1' ]];then
	expr $height + 0 &>/dev/null
	returnheight=$?
	expr $width + 0 &>/dev/null
	returnwidth=$?
	if [[ ! $returnheight == '0' || ! $returnwidth == '0' ]];then
		fault_to_exit
	fi
	if [ ! -f '/var/mobile/Library/Preferences/com.apple.iokit.IOMobileGraphicsFamily.plist' ];then
		plutil -create /var/mobile/Library/Preferences/com.apple.iokit.IOMobileGraphicsFamily.plist
		chown mobile:mobile /var/mobile/Library/Preferences/com.apple.iokit.IOMobileGraphicsFamily.plist
		chmod 0600 /var/mobile/Library/Preferences/com.apple.iokit.IOMobileGraphicsFamily.plist
	fi
	plutil -key canvas_height -int $height /var/mobile/Library/Preferences/com.apple.iokit.IOMobileGraphicsFamily.plist
	plutil -key canvas_width -int $width /var/mobile/Library/Preferences/com.apple.iokit.IOMobileGraphicsFamily.plist
     	if [[ ! $3 == '-w' ]];then
		sleep 1
		echo "Successfully set the resolution to ${height}x${width}, the device will be respring."
		if [[ -f /usr/bin/sbreload ]];then
			killall -9 cfprefsd && sbreload
		else
			killall -9 cfprefsd && killall -9 backboardd
		fi
	else
		killall -9 cfprefsd
		echo "Successfully set the resolution to ${height}x${width}, you should manual respring your drvice."
	fi
	exit 0
elif [[ $choice == 'n' || $choice == 'N' ]];then
	resolutionsetter() {
		read -p 'Please choice a height to set:' height
		read -p 'Please choice a width to set:' width
 		if [[ ! $passconfirm == '1' ]];then
			read -p "Are you sure you want to set the resolution to ${height}x${width}?(y/n)" choice
		fi
	}
else
	fault_to_exit
fi
done
